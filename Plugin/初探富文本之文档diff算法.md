# 初探富文本之文档diff算法
当我们实现在线文档的系统时，通常需要考虑到文档的版本控制与审核能力，并且这是这是整个文档管理流程中的重要环节，那么在这个环节中通常就需要文档的`diff`能力，这样我们就可以知道文档的变更情况，例如文档草稿与线上文档的差异、私有化版本`A`与版本`B`之间的差异等等，本文就以`Quill`富文本编辑器引擎为基础，探讨文档`diff`算法的实现。

## 描述
`Quill`是一个现代富文本编辑器，具备良好的兼容性及强大的可扩展性，还提供了部分开箱即用的功能。`Quill`是在`2012`年开源的，`Quill`的出现给富文本编辑器带了很多新的东西，也是目前开源编辑器里面受众非常大的一款编辑器，至今为止的生态已经非常的丰富，可以在`GitHub`等找到大量的示例，包括比较完善的协同实现。

我们首先可以思考一个问题，如果我们描述一段普通文本的话，那么大概直接输入就可以了，比如这篇文章本身底层数据结构就是纯文本，而内容格式实际上是由编译器通过词法和语法编译出来的，可以将其理解为序列化和反序列化，而对于富文本编辑器来说，如果在编辑的时候如果高频地进行序列话和反序列化，那么性能消耗是不能接受的，所以数据结构就需要尽可能是易于读写的例如`JSON`对象，那么用`JSON`来描述富文本的方式也可以多种多样，但归根结底就是需要在部分文字上挂载额外的属性，例如`A`加粗`B`斜体的话，就是在`A`上挂载`bold`属性，在`B`上挂载`italic`属性，这样的数据结构就可以描述出富文本的内容。

对于我们今天要聊的`Quill`来说，其数据结构描述是`quill-delta`，这个数据结构的设计非常棒，并且`quill-delta`同样也可以是富文本`OT`协同算法的实现，不过我们在这里不涉及协同的内容，而我们实际上要关注的`diff`能力更多的是数据结构层面的内容，也就是说我们`diff`的实际上是数据，那么在`quill-delta`中这样*一段文本*的**数据结构**如下所示。当然`quill-delta`的表达可以非常丰富，通过`retain`、`insert`、`delete`操作可以完成对于整个文档的内容描述增删改的能力，我们在后边实现对比视图功能的时候会涉及这部分`Op`。

```javascript
{
  ops: [
    { insert: "那么在" },
    { insert: "quill-delta", attributes: { inlineCode: true } },
    { insert: "中这样" },
    { insert: "一段文本", attributes: { italic: true } },
    { insert: "的" },
    { insert: "数据结构", attributes: { bold: true } },
    { insert: "如下所示。\\n" },
  ],
};
```

看到这个数据结构我们也许会想这不就是一个普通的`JSON`嘛，那么我们直接进行`JSON`的`diff`是不是就可以了，毕竟现在有很多现成的`JSON`算法可以用，这个方法对于纯`insert`的文本内容理论上可行的只是粒度不太够，没有办法精确到具体某个字的修改，也就是说依照`quill-delta`的设计想从`A`依照`diff`的结果构造`delta`进行`compose`生成到`B`这件事并不那么轻松，是需要再进行一次转换的。例如下面的`JSON`，我们`diff`的结果是删除了`insert: 1`，添加了`"insert": "12",  "attributes": { "bold": true }`，而我们实际上作出的变更是对`1`的样式添加了`bold`，并且添加了`2`附带`bold`，那么想要将这个`diff`结果应用到`A`上生成`B`需要做两件事，一是更精细化的内容修改，二是将`diff`的结果转换为`delta`，所以我们需要设计更好的`diff`算法，尽可能减少整个过程的复杂度。

```js
// A
[
  { "insert": "1" }
]

// B
[
  {
    "insert": "12",
    "attributes": { "bold": true } 
  }
]
```

## diff-delta
在这里我们的目标是希望实现更细粒度的`diff`，并且可以直接构造`delta`并且应用，也就是`A.apply(diff(a, b)) = B`，实际上在`quill-delta`中是存在已经实现好的`diff`算法，在这里我们只是将其精简了一些非`insert`的操作以便于理解，需要注意的是在这里我们讨论的是非协同模式下的`diff`，如果是已经实现`OT`的文档编辑器可以直接从历史记录中取出相关的版本`Op`进行`compose + invert`即可，并不是必须要进行文档全文的`diff`算法。


`https://codesandbox.io/p/devbox/z9l5sl`

## 对比视图

写入文档内容

虚拟图层


## 每日一题

```
https://github.com/WindrunnerMax/EveryDay
```

## 参考

```
https://www.npmjs.com/package/quill-delta
https://github.com/quilljs/quill/issues/1125
```
