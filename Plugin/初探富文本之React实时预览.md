# 初探富文本之React实时预览
在前文中我们探讨了很多关于富文本引擎和协同的能力，在本文中我们更偏向具体的应用实现。在一些场景中比如组件库的文档编写时，我们希望能够有实时预览的能力，也就是用户可以在文档中直接编写代码，然后在页面中实时预览，这样可以让用户更加直观的了解组件的使用方式，这也是很多组件库文档中都会有的一个功能。那么我们在本文就侧重于`React`组件的实时预览，来探讨相关能力的实现。

## 描述
首先我们先简单探讨下相关的场景，实际上当前很多组件库的`API`文档都是由`Markdown`来直接生成的，例如`arco-design`，实际上是通过一个个`md`文件来生成的组件应用示例以及`API`表格，那么其实我们用的时候也可以发现我们是无法直接在官网编辑代码来实时预览的，这是因为这种方式是直接利用`loader`来将`md`文件根据一定的规则编译成了`jsx`语法，这样实际上就相当于直接用`md`生成了代码，之后就是完整地走了代码打包流程。那么既然有静态部署的`API`文档，肯定也有动态渲染组件的`API`文档，例如`mui`，其同样也是通过`loader`处理`md`文件的占位，将相应的`jsx`组件通过指定的位置加载进去，只不过其的渲染方式除了静态编译完成后还多了动态渲染的能力，官网的代码示例就是可以实时编辑的，并且能够即使预览效果。

这种小规模的`Playground`能力应用还是比较广泛的，其比较小而不至于使用类似于`code-sandbox`的能力来做完整的演示，基于`Markdown`来完成文档对于技术同学来说并不是什么难事，但是`Markdown`毕竟不是一个可以广泛接受的能力，还是需要有一定的学习成本的，富文本能力会相对更容易接受一些，那么有场景就有需求，我们同样也会希望能在富文本中实现这种动态渲染组件的能力，这种能力适合做成一种按需加载的第三方插件的形式。此外，在富文本的实现中可能会有一些非常复杂的场景，例如第三方接口常用的折叠表格能力，这不是一个常见的场景而且在富文本中实现成本会特别高，尤其体现在实现交互上，`ROI`会比较低，而实际上公司内部一般都会有自己的`API`接口平台，于是利用`OpenAPI`对接接口平台直接生成折叠表格等复杂组件就是一个相对可以接受的方式。上述的两种场景下实际上都需要动态渲染组件的能力，`Playground`能力的能力比较好理解，而对接接口平台需要动态渲染组件的原因是我们的数据结构大概率是无法平齐的，例如某些文本需要加粗，成本最低的方案就是我们直接组装为`<strong />`的标签，并入已有组件库的折叠表格中将其渲染出来即可。

我们在这里也简单聊一下富文本中实现预览能力可以参考的方案，预览块的结构实际上很简单，无非是一部分是代码块，在编辑时另一部分可以实时预览，而在富文本中实现代码块一般都会有比较多的示例，例如使用`slate`时可以使用`decorate`的能力，或者可以在`quill`采用通用的方案，使用`prismjs`或者`lowlight`来解析整个代码块，之后将解析出的部分依次作为`text`的内容并且携带解析的属性放置于数据结构中，在渲染时根据属性来渲染出相应的样式即可，甚至于可以直接嵌套代码编辑器进去，只不过这样文档级别的搜索替换会比较难做，而且需要注意事件冒泡的处理，而预览区域主要需要做的是将渲染出的内容标记为`embed/void`，避免选区变换对编辑器的`Model`造成影响。

那么接下来我们进入正题，如何动态渲染`React`组件来完成实时预览，我们首先来探究一下实现方向，实际上我们可以简单思考一下，实现一个动态渲染的组件实际上不就是从字符串到可执行代码嘛，那么如果在`Js`中我们能直接执行代码中能直接执行代码的方法有两个: `eval`和`new Function`，那么我们肯定是不能用`eval`的，`eval`执行的代码将在当前作用域中执行，这意味着其可以访问和修改当前作用域中的变量，虽然在严格模式下做了一些限制但明显还是没那么安全，这可能导致安全风险和意外的副作用，而`new Function`构造函数创建的函数有自己的作用域，其只能访问全局作用域和传递给它的参数，从而更容易控制代码的执行环境，在后文中安全也是我们需要考虑的问题，所以我们肯定是需要用`new Function`来实现动态代码执行的。

```js
"use strict";

;(() => {
  let a = 1;
  eval("a = 2;")
  console.log(a); // 2
})();

;(() => {
  let a = 1;
  const fn = new Function("a = 2;");
  fn();
  console.log(a); // 1
})();
```

那么既然我们有了明确的方向，我们可以接着研究应该如何将`React`代码渲染出来，毕竟浏览器是不能直接执行`React`代码的，文中相关的代码都在`https://github.com/WindrunnerMax/ReactLive`中，也可以在`Git Pages`在线预览实现效果。

## 编译器

## 代码构造

## 渲染

## 安全



## 每日一题

```
https://github.com/WindrunnerMax/EveryDay
```

## 参考

```
https://swc.rs/docs/usage/wasm
https://github.com/alangpierce/sucrase
https://babel.dev/docs/babel-standalone
https://github.com/simonguo/react-code-view
https://github.com/LinFeng1997/markdown-it-react-component/
```



